name: Build and publish image
on:
  push:
  schedule:
    - cron: '0 8 * * 1'

jobs:
    buildIde:
        #needs: [buildBase]
        runs-on: ubuntu-latest
        name: Build and publish image job
        strategy:
          max-parallel: 2
          fail-fast: false
          matrix:
            ide: ['CLion', 'GoLand', 'IntelliJ Idea Community', 'IntelliJ Idea Education', 'IntelliJ Idea Ultimate', 'PhpStorm', 'PyCharm Education', 'PyCharm Professional', 'RubyMine', 'WebStorm']
            variant: ['2021.2.2', '2020.3.5']
        steps:
            - name: Checkout master
              uses: actions/checkout@master
            - name: Retrieve latest version
              id: latest-version
              run: |
                ide_name=$(echo ${{ matrix.ide }} | awk '{print tolower($0)}' | tr -s ' ' '-')
                echo "::set-output name=ide-name::$ide_name"
            - name: Build and publish image
              uses: ilteoood/docker_buildx@master
              with:
                tag: ${{ matrix.variant }}
                imageName: ilteoood/${{ steps.latest-version.outputs.ide-name }}
                platform: linux/amd64,linux/arm64,linux/arm/v7
                publish: true
                dockerUser: ilteoood
                dockerPassword: ${{ secrets.DOCKER_HUB_PASSWORD }}
                dockerFile: ${{ matrix.ide }}/Dockerfile
                buildArg: IDE_VERSION=${{ matrix.ide }} ${{ matrix.variant }}
